<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Список игр</title>
    <style>
        * {
            font-size: 16px;
            font-family: Tahoma;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            cursor: pointer;
        }
        th:hover {
            background-color: #ddd;
        }
        .control-panel {
            margin: 10px 0;
        }
        .price {
            float: right;
            color: #666;
        }
        .loading {
            color: #888;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <button id="fetchPrices">Узнать цены</button>
    </div>
    <table id="gamesTable">
        <thead>
            <tr>
                <th onclick="sortTable(0)">Игра</th>
            </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
    </table>

    <script>
        const BASE_URL = "https://store.steampowered.com/app/";
        
        const gamesData = [
            ["2599370", "DeathWatchers"],
            ["1048100", "Peekaboo"],
            ["3018070", "Escape Horror Online"],
            ["1966720", "Lethal Company"],
            ["2881650", "Content Warning"],
            ["2328750", "My Little Universe"],
            ["3059070", "The Headliners"],
            ["739630", "Phasmophobia"],
            ["105600", "Terraria"],
            ["413150", "Stardew Valley"],
            ["252950", "Rocket League"],
            ["620", "Portal 2"],
            ["323850", "Move or Die"],
            ["218620", "PAYDAY 2"],
            ["477160", "Human Fall Flat"],
            ["582500", "We Were Here"],
            ["500", "Left 4 Dead"],
            ["550", "Left 4 Dead 2"],
            ["322330", "Don't Starve Together"],
            ["240720", "Getting Over It with Bennett Foddy"],
            ["285900", "Gang Beasts"],
            ["945360", "Among Us"],
            ["2247670", "Hide and Seek"],
            ["1747430", "Bomberpet"],
            ["325210", "Arctico"]
        ];

        let sortDirection = {};

        function buildTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            gamesData.forEach(game => {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                const a = document.createElement('a');
                const priceSpan = document.createElement('span');
                
                a.href = `${BASE_URL}${game[0]}/`;
                a.target = "_blank";
                a.textContent = game[1];
                
                priceSpan.className = 'price';
                priceSpan.dataset.appid = game[0]; // Сохраняем appid для последующего использования
                
                td.appendChild(a);
                td.appendChild(priceSpan);
                tr.appendChild(td);
                tbody.appendChild(tr);
            });
        }

        function sortTable(columnIndex) {
            const tbody = document.getElementById('tableBody');
            const rows = Array.from(tbody.getElementsByTagName('tr'));
            
            if (sortDirection[columnIndex] === undefined) {
                sortDirection[columnIndex] = true;
            } else {
                sortDirection[columnIndex] = !sortDirection[columnIndex];
            }

            gamesData.sort((a, b) => {
                const aValue = a[1];
                const bValue = b[1];
                
                return sortDirection[columnIndex] 
                    ? aValue.localeCompare(bValue)
                    : bValue.localeCompare(aValue);
            });

            buildTable();
        }

        async function fetchPrice(appid) {
            try {
                const response = await fetch(`${BASE_URL}${appid}/`);
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Сначала ищем приоритетный блок
                let priceElement = doc.querySelector('.discount_final_price');
                let price = priceElement ? priceElement.textContent.trim() : null;

                // Если не нашли, ищем менее приоритетный блок
                if (!price) {
                    priceElement = doc.querySelector('.game_purchase_price.price');
                    price = priceElement ? priceElement.textContent.trim() : 'Н/Д';
                }

                return price;
            } catch (error) {
                console.error(`Ошибка при получении цены для ${appid}:`, error);
                return 'Ошибка';
            }
        }

        async function fetchAllPrices() {
            const priceSpans = document.querySelectorAll('.price');
            const fetchButton = document.getElementById('fetchPrices');
            
            fetchButton.disabled = true;
            fetchButton.textContent = 'Загрузка...';

            for (const span of priceSpans) {
                span.textContent = 'Загрузка...';
                span.classList.add('loading');
                
                const appid = span.dataset.appid;
                const price = await fetchPrice(appid);
                
                span.textContent = price;
                span.classList.remove('loading');
            }

            fetchButton.disabled = false;
            fetchButton.textContent = 'Узнать цены';
        }

        // Инициализация таблицы
        window.onload = buildTable;

        // Обработчик кнопки
        document.getElementById('fetchPrices').addEventListener('click', fetchAllPrices);
    </script>
</body>
</html>